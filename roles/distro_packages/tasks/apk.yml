---
- name: Ensure alpine-conf package
  become: true
  community.general.apk:
    name: alpine-conf

- name: Ensure setup-apkrepos conf
  become: true
  ansible.builtin.command: setup-apkrepos -c1
  register: apk_setup_repos
  changed_when: '"Updating repository indexes... done." not in apk_setup_repos.stdout'

- name: Validate 'distro_packages_repos' against apk JSON schema
  with_dict: "{{ distro_packages_repos }}"
  loop_control:
    label: "{{ item.key }}"
  ansible.utils.validate:
    data: "{{ item.value }}"
    engine: ansible.utils.jsonschema
    criteria:
      - "{{ lookup('file', '{{ role_path }}/files/apk_repos.json') }}"

- name: Add apk repos
  become: true
  with_dict: "{{ distro_packages_repos }}"
  loop_control:
    label: "{{ item.key }}"
  ansible.builtin.lineinfile:
    path: /etc/apk/repositories
    line: "@{{ item.key }} {{ item.value.url }}"

- name: "Install {{ distro_packages | join(', ') }}"
  become: true
  community.general.apk:
    name: "{{ distro_packages }}"
